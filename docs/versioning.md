# Capability Versioning

## Overview

OmniDev tracks capability versions to ensure reproducible builds and detect updates. The system supports:

- **Git sources**: Pin to specific tags, branches, or commit hashes
- **File sources**: Track content changes via SHA-256 hashing
- **Lock file**: Record exact versions for reproducibility (`omni.lock.toml`)

## Source Types

### GitHub/Git Sources

Git-sourced capabilities support version pinning via the `version` field:

```toml
[capabilities.sources]
# Latest from default branch (explicit)
my-cap = { source = "github:user/repo", version = "latest" }

# Pin to a tag using # syntax (shorthand)
stable = "github:user/repo#v1.0.0"

# Pin to a specific commit
pinned = { source = "github:user/repo", version = "abc123def456" }

# Pin to a branch
experimental = { source = "github:user/repo", version = "feature-branch" }

# With subdirectory path
my-tool = { source = "github:user/repo", version = "v2.0.0", path = "plugins/tool" }
```

**Supported formats:**
- `github:user/repo` - GitHub shorthand
- `github:user/repo#ref` - GitHub shorthand with ref
- `https://github.com/user/repo.git` - HTTPS URL
- `git@github.com:user/repo.git` - SSH URL

### File/Local Sources

Local capabilities are tracked by content hash:

```toml
[capabilities.sources]
# Relative path
local-cap = "file://./capabilities/my-cap"

# Absolute path
system-cap = "file:///home/user/dev/my-capability"
```

**Content hashing:**
- SHA-256 hash computed across all files
- Deterministic: files processed in sorted order
- Excludes: `.git`, `node_modules`, `dist`, `build`, `__pycache__`, `.omni`

## Lock File

The `omni.lock.toml` file records the exact version of each capability:

```toml
# DO NOT EDIT - Generated by omnidev sync

[capabilities.my-cap]
source = "github:user/repo"
version = "1.2.0"
version_source = "capability.toml"
commit = "abc123def456789012345678901234567890abcd"
updated_at = "2025-01-21T10:30:00.000Z"

[capabilities.pinned-cap]
source = "github:user/repo"
version = "v1.0.0"
version_source = "commit"
commit = "def456abc789012345678901234567890abcd1234"
pinned_version = "v1.0.0"
updated_at = "2025-01-21T10:30:00.000Z"

[capabilities.local-cap]
source = "file://./capabilities/my-cap"
version = "a1b2c3d4"
version_source = "content_hash"
content_hash = "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef12345678"
updated_at = "2025-01-21T10:30:00.000Z"
```

### Lock Entry Fields

| Field | Description |
|-------|-------------|
| `source` | Original source reference |
| `version` | Detected version string |
| `version_source` | Where version was detected (see below) |
| `commit` | Full git commit hash (git sources only) |
| `pinned_version` | Pinned version if specified (git sources only) |
| `content_hash` | SHA-256 hash (file sources only) |
| `updated_at` | ISO 8601 timestamp of last update |

### Version Source Priority

Version is detected in this order:
1. `capability.toml` - explicit `version` field in `[capability]` section
2. `plugin.json` - `.claude-plugin/plugin.json` version field
3. `package.json` - version field
4. `commit` - short git commit hash (7 chars) for git sources
5. `content_hash` - short content hash (8 chars) for file sources

## Change Detection

During `omnidev sync`, changes are detected by comparing:

- **Git sources**: Current commit hash vs lock file commit
- **File sources**: Current content hash vs lock file hash

```
┌─────────────────────────────────────────────────────────────┐
│                     omnidev sync                            │
├─────────────────────────────────────────────────────────────┤
│  1. Load omni.lock.toml                                     │
│  2. For each capability source:                             │
│     - Git: fetch remote, get current commit                 │
│     - File: compute content hash                            │
│  3. Compare with lock file entry                            │
│  4. If changed or new:                                      │
│     - Re-fetch/copy capability                              │
│     - Update lock entry                                     │
│  5. Save updated omni.lock.toml                             │
└─────────────────────────────────────────────────────────────┘
```

## CLI Usage

### Adding Capabilities

```bash
# Add from GitHub (latest)
omnidev add cap --github user/repo

# Add from GitHub with subdirectory
omnidev add cap --github user/repo --path plugins/my-cap

# Add from local path
omnidev add cap --local ./capabilities/my-cap

# Specify a custom name
omnidev add cap my-name --github user/repo
```

### Syncing

```bash
# Sync all capabilities
omnidev sync
```

## Version Pinning

### Using the `--pin` Flag

The `omnidev add cap` command supports pinning to a specific version:

```bash
# Add with automatic version detection
omnidev add cap my-cap --github user/repo --pin
```

This will detect the version from `capability.toml` or fall back to the commit hash:

```toml
[capabilities.sources]
my-cap = { source = "github:user/repo", version = "v1.0.0" }
```

### Manual Version Pinning

You can also manually specify a version in `omni.toml`:

```toml
[capabilities.sources]
my-cap = { source = "github:user/repo", version = "v1.0.0" }
```

## Current Limitations

### No Change Warnings for Local Files

When local capability files change, the system silently re-syncs. There's no explicit warning shown to the user.

### No Integrity Verification

The lock file doesn't include checksums for git-sourced capabilities, only commit hashes. This means:
- No verification that cloned content matches expected hash
- Relies on git commit integrity

## Best Practices

### 1. Commit Your Lock File

Always commit `omni.lock.toml` to version control:

```bash
git add omni.lock.toml
git commit -m "Lock capability versions"
```

This ensures reproducible builds across your team.

### 2. Pin Production Capabilities

For stability, pin capabilities to specific versions:

```toml
[capabilities.sources]
# Don't do this in production
unstable = "github:user/repo"

# Do this instead
stable = "github:user/repo#v1.0.0"
```

### 3. Use Tags Over Commits

Prefer semantic version tags over raw commit hashes:

```toml
# Preferred - clear version
my-cap = "github:user/repo#v1.2.3"

# Less clear - what version is this?
my-cap = "github:user/repo#abc123def"
```

### 4. Review Lock File Changes

When the lock file changes, review what updated:

```bash
git diff omni.lock.toml
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        omni.toml                            │
│  [capabilities.sources]                                     │
│  my-cap = { source = "github:user/repo", version = "v1.0.0" }│
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Source Parser                             │
│  parseSourceConfig() → GitCapabilitySourceConfig           │
│    { source: "github:user/repo", version: "v1.0.0" }       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Capability Fetcher                        │
│  - Git: clone --depth 1 --branch <version>                 │
│  - File: copy + compute content hash                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   omni.lock.toml                            │
│  [capabilities.my-cap]                                      │
│  source = "github:user/repo"                               │
│  version = "1.0.0"                                         │
│  commit = "abc123..."                                      │
│  pinned_version = "v1.0.0"                                 │
└─────────────────────────────────────────────────────────────┘
```

## Type Definitions

```typescript
// Source configuration options
type CapabilitySourceConfig =
  | string                        // Shorthand: "github:user/repo" or "file://./path"
  | GitCapabilitySourceConfig     // Full git config
  | FileCapabilitySourceConfig;   // Full file config

interface GitCapabilitySourceConfig {
  source: string;    // Git URL or shorthand
  version?: string;  // "latest", tag, branch, or commit hash
  path?: string;     // Subdirectory within repo
}

interface FileCapabilitySourceConfig {
  source: string;    // "file://..." path
}

// Lock file entry
interface CapabilityLockEntry {
  source: string;
  version: string;
  version_source?: VersionSource;
  commit?: string;           // Git sources
  pinned_version?: string;   // Pinned version from config
  content_hash?: string;     // File sources
  updated_at: string;
}

type VersionSource =
  | "capability.toml"
  | "plugin.json"
  | "package.json"
  | "commit"
  | "content_hash";
```

## Next Steps

Planned improvements to the versioning system:

1. **CLI `--ref` flag** - Add `omnidev add cap --github user/repo --ref v1.0.0`
2. **Update command** - `omnidev update [cap-id]` to check and apply updates
3. **Change warnings** - Notify when local capability files have changed
4. **Update summary** - Show what changed during sync (version diff)
5. **Integrity checks** - Optional content hash verification for git sources
